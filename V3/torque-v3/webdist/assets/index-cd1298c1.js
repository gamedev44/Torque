(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&t(l)}).observe(document,{childList:!0,subtree:!0});function e(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerpolicy&&(a.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?a.credentials="include":n.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function t(n){if(n.ep)return;n.ep=!0;const a=e(n);fetch(n.href,a)}})();/**
 * Torque.JS: Engine Configuration Definitions
 * 
 * @license Semi-Open Source with Attribution
 * Copyright (c) 2025 Iron Will Interactive
 * Developed by: Asterisk
 * 
 * This module contains default engine configurations for all supported engines.
 * See LICENSE file for full license terms and attribution requirements.
 * 
 * Maker's Mark: TQJS-V3-CONFIG-2025-IWI
 */const G={tranny_on:{source:"./audio/trany_power_high.wav",rpm:0,volume:.4},tranny_off:{source:"./audio/tw_offlow_4 {0da7d8b9-9064-4108-998b-801699d71790}.wav",rpm:0,volume:.2}},Xe={engine:{limiter:8e3,soft_limiter:7900,limiter_ms:0,inertia:1},drivetrain:{shiftTime:50,damping:16,gears:[3.4,2.36,1.85,1.47,1.24,1.07]},sounds:{...G,on_high:{source:"./audio/BAC_Mono_onhigh.wav",rpm:1e3,volume:.5},on_low:{source:"./audio/BAC_Mono_onlow.wav",rpm:1e3,volume:.5},off_high:{source:"./audio/BAC_Mono_offveryhigh.wav",rpm:1e3,volume:.5},off_low:{source:"./audio/BAC_Mono_offlow.wav",rpm:1e3,volume:.5},limiter:{source:"./audio/limiter.wav",volume:.4,rpm:8e3}}},Ye={engine:{limiter:8900,soft_limiter:8800,limiter_ms:0,inertia:.8},drivetrain:{shiftTime:10,damping:6,gears:[3.6,2.5,1.9,1.5,1.2,1]},sounds:{...G,on_high:{source:"./audio/458/power_2 {1d0b3340-525d-418d-b809-a61f94a1d76a}.wav",rpm:7700,volume:2.5},on_low:{source:"./audio/458/mid_res_2 {a777a51b-a829-4637-ac37-ccdaca0a3e9b}.wav",rpm:5300,volume:1.5},off_high:{source:"./audio/458/off_higher {b1e2e686-3bd7-43df-9cf9-3b8c1afcffc1}.wav",rpm:7900,volume:1.6},off_low:{source:"./audio/458/off_midhigh {94a99615-de6b-4b18-a977-a3b5e9b10641}.wav",rpm:6900,volume:1.4},limiter:{source:"./audio/458/limiter.wav",volume:1.8,rpm:0}}},Ke={engine:{limiter:9e3,soft_limiter:9e3,limiter_ms:150},drivetrain:{shiftTime:100,damping:12,gears:[3.5,2.4,1.8,1.4,1.15,.95]},sounds:{on_high:{source:"./audio/procar/on_midhigh {eed64b99-c102-43cf-834e-4e4cafa68fdc}.wav",rpm:8e3},on_low:{source:"./audio/procar/on_low {0477930f-2954-45ee-8ac4-db4867fe1749}.wav",rpm:3200},off_high:{source:"./audio/procar/off_midhigh {092a60f7-c729-4d2c-979e-2e766ba42c6c}.wav",rpm:8430,volume:1.3},off_low:{source:"./audio/procar/off_lower {05f28dcf-8251-4e6a-bc40-8099139ef81e}.wav",rpm:3400,volume:1.3},limiter:{source:"./audio/limiter.wav",volume:.5,rpm:8e3}}},je={engine:{idle:800,limiter:6500,soft_limiter:6400,limiter_ms:0,inertia:.7,torque:250,engine_braking:150},drivetrain:{shiftTime:70,damping:18,compliance:.01,final_drive:3.44,gears:[3.8,2.6,2,1.6,1.3,1.1]},sounds:{...G,on_high:{source:"./audio/BAC_Mono_onhigh.wav",rpm:3500,volume:.55},on_low:{source:"./audio/BAC_Mono_onlow.wav",rpm:1300,volume:.45},off_high:{source:"./audio/BAC_Mono_offveryhigh.wav",rpm:5500,volume:.55},off_low:{source:"./audio/BAC_Mono_offlow.wav",rpm:1e3,volume:.45},limiter:{source:"./audio/limiter.wav",volume:.35,rpm:6500}}},Je={engine:{idle:900,limiter:7e3,soft_limiter:6900,limiter_ms:0,inertia:.8,torque:300,engine_braking:170},drivetrain:{shiftTime:65,damping:17,compliance:.01,final_drive:3.44,gears:[3.7,2.5,1.95,1.55,1.25,1.05]},sounds:{...G,on_high:{source:"./audio/BAC_Mono_onhigh.wav",rpm:4e3,volume:.6},on_low:{source:"./audio/BAC_Mono_onlow.wav",rpm:1500,volume:.5},off_high:{source:"./audio/BAC_Mono_offveryhigh.wav",rpm:6e3,volume:.6},off_low:{source:"./audio/BAC_Mono_offlow.wav",rpm:1200,volume:.5},limiter:{source:"./audio/limiter.wav",volume:.4,rpm:6800}}},Ze={engine:{idle:1e3,limiter:7200,soft_limiter:7100,limiter_ms:0,inertia:.9,torque:350,engine_braking:180},drivetrain:{shiftTime:60,damping:14,compliance:.01,final_drive:3.44,gears:[3.6,2.45,1.9,1.5,1.22,1]},sounds:{...G,on_high:{source:"./audio/BAC_Mono_onhigh.wav",rpm:4500,volume:.65},on_low:{source:"./audio/BAC_Mono_onlow.wav",rpm:1800,volume:.55},off_high:{source:"./audio/BAC_Mono_offveryhigh.wav",rpm:6500,volume:.65},off_low:{source:"./audio/BAC_Mono_offlow.wav",rpm:1400,volume:.55},limiter:{source:"./audio/limiter.wav",volume:.45,rpm:7200}}},Qe={engine:{idle:1e3,limiter:8500,soft_limiter:8400,limiter_ms:0,inertia:1,torque:400,engine_braking:200},drivetrain:{shiftTime:50,damping:16,compliance:.01,final_drive:3.44,gears:[3.5,2.4,1.85,1.45,1.18,.95]},sounds:{...G,on_high:{source:"./audio/BAC_Mono_onhigh.wav",rpm:5e3,volume:.7},on_low:{source:"./audio/BAC_Mono_onlow.wav",rpm:2e3,volume:.6},off_high:{source:"./audio/BAC_Mono_offveryhigh.wav",rpm:7e3,volume:.7},off_low:{source:"./audio/BAC_Mono_offlow.wav",rpm:1500,volume:.6},limiter:{source:"./audio/limiter.wav",volume:.5,rpm:8500}}},et={engine:{idle:1e3,limiter:8200,soft_limiter:8100,limiter_ms:0,inertia:1.1,torque:450,engine_braking:220},drivetrain:{shiftTime:45,damping:15,compliance:.01,final_drive:3.44,gears:[3.4,2.35,1.8,1.4,1.15,.92]},sounds:{...G,on_high:{source:"./audio/BAC_Mono_onhigh.wav",rpm:5500,volume:.75},on_low:{source:"./audio/BAC_Mono_onlow.wav",rpm:2200,volume:.65},off_high:{source:"./audio/BAC_Mono_offveryhigh.wav",rpm:7500,volume:.75},off_low:{source:"./audio/BAC_Mono_offlow.wav",rpm:1600,volume:.65},limiter:{source:"./audio/limiter.wav",volume:.55,rpm:8e3}}},tt={engine:{idle:1e3,limiter:8800,soft_limiter:8700,limiter_ms:0,inertia:1.2,torque:500,engine_braking:250},drivetrain:{shiftTime:40,damping:14,compliance:.01,final_drive:3.44,gears:[3.3,2.3,1.75,1.35,1.12,.9]},sounds:{...G,on_high:{source:"./audio/BAC_Mono_onhigh.wav",rpm:6e3,volume:.8},on_low:{source:"./audio/BAC_Mono_onlow.wav",rpm:2400,volume:.7},off_high:{source:"./audio/BAC_Mono_offveryhigh.wav",rpm:7800,volume:.8},off_low:{source:"./audio/BAC_Mono_offlow.wav",rpm:1700,volume:.7},limiter:{source:"./audio/limiter.wav",volume:.6,rpm:7500}}},it={engine:{idle:1100,limiter:6800,soft_limiter:6700,limiter_ms:0,inertia:1.3,torque:550,engine_braking:280},drivetrain:{shiftTime:35,damping:13,compliance:.01,final_drive:3.44,gears:[3.2,2.25,1.7,1.3,1.1,.88]},sounds:{...G,on_high:{source:"./audio/BAC_Mono_onhigh.wav",rpm:6500,volume:.85},on_low:{source:"./audio/BAC_Mono_onlow.wav",rpm:2600,volume:.75},off_high:{source:"./audio/BAC_Mono_offveryhigh.wav",rpm:7200,volume:.85},off_low:{source:"./audio/BAC_Mono_offlow.wav",rpm:1800,volume:.75},limiter:{source:"./audio/limiter.wav",volume:.65,rpm:7e3}}},Le=Object.freeze(Object.defineProperty({__proto__:null,bac_mono:Xe,ferr_458:Ye,procar:Ke,v10:et,v12:tt,v16:it,v2:je,v4:Je,v6:Ze,v8:Qe},Symbol.toStringTag,{value:"Module"}));/**
 * Torque.JS: Utility - Clamp Function
 * 
 * @license Semi-Open Source with Attribution
 * Copyright (c) 2025 Iron Will Interactive
 * Maker's Mark: TQJS-V3-UTIL-CLAMP-2025-IWI
 */function R(o,i,e){return Math.min(Math.max(o,i),e)}/**
 * Torque.JS: Audio Manager Module
 * 
 * @license Semi-Open Source with Attribution
 * Copyright (c) 2025 Iron Will Interactive
 * Developed by: Asterisk
 * 
 * This module handles audio synthesis and Web Audio API integration.
 * See LICENSE file for full license terms and attribution requirements.
 * 
 * Maker's Mark: TQJS-V3-AUDIO-2025-IWI
 */class nt{constructor(i,e,t=1e3,n=1){this.gain=i,this.audio=e,this.rpm=t,this.volume=n}}class re{ctx;volume;analyser;samples={};async init(i){if(!this.ctx){this.ctx=new AudioContext,this.volume=new GainNode(this.ctx),this.analyser=this.ctx.createAnalyser(),this.analyser.fftSize=256,this.analyser.smoothingTimeConstant=.8,this.volume.connect(this.analyser),this.analyser.connect(this.ctx.destination);for(const e in i)this.samples[e]=await this.add(i[e]);this.ctx.state==="suspended"&&this.ctx.resume()}}async add(i){const e=this.ctx.createBufferSource();let t=null;const n=(l=1)=>{try{const s=this.ctx.sampleRate||44100,d=Math.max(1,Math.floor(s*l)),u=this.ctx.createBuffer(1,d,s),m=u.getChannelData(0);for(let c=0;c<d;c++)m[c]=0;return u}catch{return null}};try{if(i?.source){const l=await fetch(i.source);if(!l.ok)throw new Error(`Failed to fetch: ${i.source} (status ${l.status})`);const s=await l.arrayBuffer();t=await this.ctx.decodeAudioData(s)}}catch(l){console.warn("Audio sample load failed, using silent buffer:",i?.source,l),t=n(1)}t||(t=n(1)),e.buffer=t,e.loop=!0;const a=new GainNode(this.ctx);return a.gain.value=0,e.connect(a).connect(this.volume).connect(this.ctx.destination),e.start(),new nt(a,e,i.rpm,i.volume)}static crossFade(i,e,t){const n=R((i-e)/(t-e),0,1),a=Math.cos((1-n)*.5*Math.PI),l=Math.cos(n*.5*Math.PI);return{gain1:a,gain2:l}}dispose(){this.ctx&&this.ctx.close()}}/**
 * Torque.JS: Utility - Ratio Function
 * 
 * @license Semi-Open Source with Attribution
 * Copyright (c) 2025 Iron Will Interactive
 * Maker's Mark: TQJS-V3-UTIL-RATIO-2025-IWI
 */function ne(o,i,e){return R((o-i)/(e-i),0,1)}/**
 * Torque.JS: Engine Physics Module
 * 
 * @license Semi-Open Source with Attribution
 * Copyright (c) 2025 Iron Will Interactive
 * Developed by: Asterisk
 * 
 * This module handles engine physics simulation including RPM, torque, and limiter logic.
 * See LICENSE file for full license terms and attribution requirements.
 * 
 * Maker's Mark: TQJS-V3-ENGINE-2025-IWI
 */class ot{idle=1e3;limiter=0;soft_limiter=0;rpm=this.idle;inertia=.2+.8;limiter_ms=0;limiter_delay=100;#e=0;torque=400;engine_braking=200;throttle=0;theta=0;alpha=0;omega=0;prevTheta=0;prevOmega=0;dTheta=0;omega_max=0;constructor(){this.init()}init(i){console.log(this.limiter),i&&Object.assign(this,i),this.omega_max=2*Math.PI*this.limiter/60,this.soft_limiter=i?.soft_limiter??this.limiter*.99,this.theta=0,this.alpha=0,this.omega=0,this.prevTheta=0,this.prevOmega=0,this.dTheta=0,this.rpm=0}integrate(i=0,e,t){if(this.rpm>=this.soft_limiter){const m=ne(this.rpm,this.soft_limiter,this.limiter);this.throttle*=Math.pow(1-m,.05)}if(this.rpm>=this.limiter&&(this.#e=e),e-this.#e>=this.limiter_ms){const m=e-this.#e,c=ne(m,0,this.limiter_delay);this.throttle*=c}else this.throttle=0;let n=0;this.throttle<.1&&this.rpm<this.idle*1.5&&(n=(1-ne(this.rpm,this.idle*.9,this.idle))*this.engine_braking*10);const a=Math.pow(this.throttle,1.2)*this.torque,l=Math.pow(1-this.throttle,1.2)*this.engine_braking,s=a-l+n,d=i+this.inertia,u=s/d;this.prevTheta=this.theta,this.omega+=u*t,this.theta+=this.omega*t,this.dTheta=this.omega*t,this.rpm=60*this.omega/2*Math.PI}update(i){this.prevOmega=this.omega;const e=(this.theta-this.prevTheta)/i;this.omega=e}solvePos(i,e){if(i.gear===0)return;const t=Math.max(6e-4-15e-5*i.gear,7e-5),n=i.theta-this.theta,a=this.getCorrection(n,e,t);this.theta+=a*Math.sign(n)}solveVel(i,e){let t=12;i.gear>3&&(t=9),this.omega+=(i.omega-this.omega)*t*e}getCorrection(i,e,t=0){const n=i*i*1/this.inertia,a=-i/(n+t/e/e);return i*-a}applySounds(i,e=0,t=.2){const{gain1:n,gain2:a}=re.crossFade(this.rpm,3e3,6500),{gain1:l,gain2:s}=re.crossFade(this.throttle,0,1),d=ne(this.rpm,this.soft_limiter*.93,this.limiter),u=(m,c,g=!0)=>{i[m]&&(g&&(i[m].audio.detune.value=this.getRPMPitch(i[m].rpm,t)),i[m].gain.gain.value=c*i[m].volume)};u("on_low",l*a),u("off_low",s*a),u("on_high",l*n),u("off_high",s*n),u("limiter",d,!1),i.tranny_on&&i.tranny_off&&(i.tranny_on.audio.detune.value=this.rpm*e*.05-100,i.tranny_on.gain.gain.value=e>0?l*i.tranny_on.volume:0,i.tranny_off.audio.detune.value=this.rpm*e*.035-800,i.tranny_off.gain.gain.value=e>0?s*i.tranny_off.volume:0)}getRPMPitch(i,e){return(this.rpm-i)*e}}/**
 * Torque.JS: Drivetrain Physics Module
 * 
 * @license Semi-Open Source with Attribution
 * Copyright (c) 2025 Iron Will Interactive
 * Developed by: Asterisk
 * 
 * This module handles drivetrain simulation including gear ratios and transmission physics.
 * See LICENSE file for full license terms and attribution requirements.
 * 
 * Maker's Mark: TQJS-V3-DRIVETRAIN-2025-IWI
 */class at{gear=0;clutch=1;downShift=!1;gears=[3.4,2.36,1.85,1.47,1.24,1.07];final_drive=3.44;theta=0;omega=0;prevTheta=0;prevOmega=0;theta_wheel=0;omega_wheel=0;inertia=.1+.05;damping=12;compliance=.01;shiftTime=50;constructor(){this.init()}init(i){i&&Object.assign(this,i),this.theta=0,this.omega=0,this.prevTheta=0,this.prevOmega=0,this.theta_wheel=0,this.omega_wheel=0,this.gear=0}integrate(i){this.clutch=R(this.clutch,0,1),this.prevTheta=this.theta,this.theta+=this.omega*i}update(i){this.prevOmega=this.omega;const e=(this.theta-this.prevTheta)/i;this.omega=e}solvePos(i,e){const t=i.theta-this.theta,n=this.getCorrection(t,e,this.compliance);this.theta+=n*Math.sign(t)}solveVel(i,e){let t=this.damping;this.gear>3&&(t=this.damping*.75),this.omega+=(i.omega-this.omega)*t*e}getCorrection(i,e,t=0){const n=i*i*1/this.inertia,a=-i/(n+t/e/e);return i*-a}getFinalDriveRatio(){return this.final_drive}getGearRatio(i){return i=i??this.gear,i=R(i,0,this.gears.length),i>0?this.gears[i-1]:0}getTotalGearRatio(){return this.getGearRatio()*this.getFinalDriveRatio()}changeGear(i){const e=this.getGearRatio(this.gear),t=this.getGearRatio(i),n=e>0?t/e:0;n!==1&&(this.gear=0,n>1&&(this.downShift=!0),setTimeout(()=>{this.omega=this.omega*n,this.gear=i,this.gear=R(i,0,this.gears.length),this.downShift=!1,console.log("Changed",this.gear)},this.shiftTime))}nextGear(){this.changeGear(this.gear+1)}prevGear(){this.changeGear(this.gear-1)}}/**
 * Torque.JS: Vehicle Physics Module
 * 
 * @license Semi-Open Source with Attribution
 * Copyright (c) 2025 Iron Will Interactive
 * Developed by: Asterisk
 * 
 * This module handles vehicle physics simulation integrating engine, drivetrain, and audio.
 * See LICENSE file for full license terms and attribution requirements.
 * 
 * Maker's Mark: TQJS-V3-VEHICLE-2025-IWI
 */class st{audio=new re;engine=new ot;drivetrain=new at;mass=500;velocity=0;wheel_rpm=0;wheel_omega=0;wheel_radius=.25;async init(i){this.audio&&this.audio.dispose(),this.engine.init(i.engine),this.drivetrain.init(i.drivetrain),this.audio=new re,await this.audio.init(i.sounds)}update(i,e){const n=e/20,a=this.getLoadInertia()*0;for(let l=0;l<20;l++)this.engine.integrate(a,i+e*l,n),this.drivetrain.integrate(n),this.engine.solvePos(this.drivetrain,n),this.drivetrain.solvePos(this.engine,n),this.engine.update(n),this.drivetrain.update(n),this.engine.solveVel(this.drivetrain,n),this.drivetrain.solveVel(this.engine,n);this.audio.ctx&&this.engine.applySounds(this.audio.samples,this.drivetrain.gear)}getLoadInertia(){if(this.drivetrain.gear==0)return 0;const i=this.drivetrain.getGearRatio(),e=this.drivetrain.getTotalGearRatio(),t=this.mass*Math.pow(this.wheel_radius,2),n=4*12*Math.pow(this.wheel_radius,2),a=t/Math.pow(e,2),l=n/Math.pow(e,2),s=this.drivetrain.inertia/Math.pow(i,2);return a+l+s}}/**
 * Torque.JS: Engine Sound Emulator V3
 * 
 * @license Semi-Open Source with Attribution
 * Copyright (c) 2025 Iron Will Interactive
 * Developed by: Asterisk
 * 
 * This file is part of Torque.JS V3 - Advanced TypeScript Engine Sound Emulator
 * See LICENSE file for full license terms and attribution requirements.
 * 
 * Maker's Mark: TQJS-V3-MAIN-2025-IWI
 */let X=!1,b=!1;const J={activeConfig:"bac_mono"};let ie=!0,D=7650,k="./assets/Engines/V/V8.mp4";const E=new st,r=E.engine,v=E.drivetrain,Te=document.getElementById("start_btn"),Be=document.getElementById("stop_btn");document.getElementById("controls");const P=document.getElementById("status-display");document.getElementById("engine-status");const W=document.getElementById("throttle-slider"),le=document.getElementById("throttle-value"),rt=document.getElementById("select-engine-btn"),L=document.getElementById("engine-modal"),lt=document.getElementById("close-engine-modal"),oe=document.getElementById("current-engine-display"),ae=document.getElementById("engine-templates-grid"),se=document.getElementById("engine-basic-grid"),_e=document.getElementById("engine-custom-grid"),Pe=document.getElementById("custom-engines-section"),B=document.getElementById("engine-modal-search"),M=document.getElementById("engine-modal-search-results"),w=document.getElementById("waveform-canvas"),h=document.getElementById("engine-video-canvas"),dt=document.getElementById("test-rev-slider"),Ae=document.getElementById("test-rev-value"),de=document.getElementById("slider-rpm-start"),ce=document.getElementById("slider-rpm-end"),me=document.getElementById("val-rpm-start"),ue=document.getElementById("val-rpm-end"),Ne=document.getElementById("toggle-advanced"),we=document.getElementById("advanced-panel"),Oe=document.getElementById("toggle-drivetrain"),Ee=document.getElementById("drivetrain-panel");let x=null,ee=null,te=[];const ge=document.getElementById("btn-record"),he=document.getElementById("btn-stop"),Se=document.getElementById("rec-status");let De=function(i,e){let t,n,a=(e.valueMax-e.valueMin)/e.valueStep,l=(e.angleMax-e.angleMin)/a,s=10,d=0,u=function(f){return Math.max(e.valueMin,Math.min(e.valueMax,f))/(e.valueMax-e.valueMin)*(e.angleMax-e.angleMin)+e.angleMin};this.setValue=function(f){t.style.transform="translate3d(-50%, 0, 0) rotate("+Math.round(u(f))+"deg)",n&&(n.innerHTML=e.needleFormat(f))},this.updateConfig=function(f){Object.assign(e,f),a=(e.valueMax-e.valueMin)/e.valueStep,l=(e.angleMax-e.angleMin)/a};let m=function(f){f.target.closest(".meter")?.classList.toggle("meter--big-label")},c=function(f,C,_,I){let T=document.createElement("div");if(T.className=C,_&&(T.innerHTML=_),I)for(var H in I)T.style[H]=I[H];return f.appendChild(T),T};c(i,"label label-unit",e.valueUnit);for(let f=0;f<a+1;f++){let C=e.valueMin+f*e.valueStep;d=e.angleMin+f*l;let _="";e.valueRed&&C>e.valueRed&&(_=" redzone"),c(i,"grad grad--"+f+_,e.labelFormat(C),{left:50-(50-s)*Math.sin(d*(Math.PI/180))+"%",top:50+(50-s)*Math.cos(d*(Math.PI/180))+"%"}),c(i,"grad-tick grad-tick--"+f+_,"",{left:50-50*Math.sin(d*(Math.PI/180))+"%",top:50+50*Math.cos(d*(Math.PI/180))+"%",transform:"translate3d(-50%, 0, 0) rotate("+(d+180)+"deg)"}),d+=l/2,d<e.angleMax&&c(i,"grad-tick grad-tick--half grad-tick--"+f+_,"",{left:50-50*Math.sin(d*(Math.PI/180))+"%",top:50+50*Math.cos(d*(Math.PI/180))+"%",transform:"translate3d(-50%, 0, 0) rotate("+(d+180)+"deg)"}),d+=l/4,d<e.angleMax&&c(i,"grad-tick grad-tick--quarter grad-tick--"+f+_,"",{left:50-50*Math.sin(d*(Math.PI/180))+"%",top:50+50*Math.cos(d*(Math.PI/180))+"%",transform:"translate3d(-50%, 0, 0) rotate("+(d+180)+"deg)"}),d-=l/2,d<e.angleMax&&c(i,"grad-tick grad-tick--quarter grad-tick--"+f+_,"",{left:50-50*Math.sin(d*(Math.PI/180))+"%",top:50+50*Math.cos(d*(Math.PI/180))+"%",transform:"translate3d(-50%, 0, 0) rotate("+(d+180)+"deg)"})}d=u(e.value),t=c(i,"needle","",{transform:"translate3d(-50%, 0, 0) rotate("+d+"deg)"}),c(i,"needle-axle","").addEventListener("click",m),c(i,"label label-value","<div>"+e.labelFormat(e.value)+"</div><span>"+e.labelUnit+"</span>").addEventListener("click",m),n=i.querySelector(".label-value div")},A=null,S=null;function fe(){const o=document.getElementById("gauge-speed"),i=document.getElementById("gauge-rpm");let e=300;if(window.currentEngineConfig){const a=window.currentEngineConfig;a.gauges&&(a.gauges.max_speed_kmh!==void 0?e=a.gauges.max_speed_kmh:a.gauges.MAX_SPEED_KMH!==void 0&&(e=a.gauges.MAX_SPEED_KMH))}if(console.log("initGauges - maxSpeed:",e,"from config:",window.currentEngineConfig?.gauges),e=Math.ceil(e/10)*10,o&&(o.innerHTML="",A=new De(o,{value:0,valueMin:0,valueMax:e,valueStep:e/10,valueUnit:"<div>Speed</div><span>km/h</span>",angleMin:30,angleMax:330,labelUnit:"km/h",labelFormat:a=>Math.round(a),needleFormat:a=>Math.round(a),valueRed:e*.8}),A.setValue(0)),i){i.innerHTML="";const a=r&&r.limiter?r.limiter:9e3,l=Math.ceil(a/500)*500,s=l/10,d=a*.85;S=new De(i,{value:r&&r.idle?r.idle:0,valueMin:0,valueMax:l,valueStep:s,valueUnit:"<div>RPM</div><span>x1000</span>",angleMin:30,angleMax:330,labelUnit:"RPM",labelFormat:u=>Math.round(u/1e3),needleFormat:u=>Math.round(u/100)*100,valueRed:d}),S.setValue(r&&r.idle?r.idle:0)}const t=document.getElementById("engine-video");if(t){const a=z(J.activeConfig);if(console.log("Initializing video with path:",a),t.src=a,k=a,h){const s=document.getElementById("gif-container");if(s){const d=()=>{const u=s.getBoundingClientRect();h.width=u.width,h.height=u.height};d(),window.addEventListener("resize",d)}}t.onerror=s=>{console.error("Video initialization error:",a,t.error)},t.onloadstart=()=>{console.log("Video load started:",a)},t.onloadeddata=()=>{console.log("Video data loaded:",a)},t.oncanplay=()=>{console.log("Video can play:",a)},t.load(),t.style.display="block",t.style.visibility="visible";const l=document.getElementById("gif-container");l&&(l.style.display="flex",l.style.visibility="visible")}const n=document.getElementById("gear-value");n&&(n.textContent="N"),F(0)}async function We(o){const i=Le[o]||null;try{const e=await fetch(`./presets/${o}.ini`);if(!e.ok)return console.warn(`INI preset not found: ./presets/${o}.ini`),i;const t=i?{engine:{...i.engine},drivetrain:{...i.drivetrain},sounds:JSON.parse(JSON.stringify(i.sounds))}:{engine:{},drivetrain:{},sounds:{}};if(!i){const s={on_high:{source:"./audio/BAC_Mono_onhigh.wav",rpm:1e3,volume:.5},on_low:{source:"./audio/BAC_Mono_onlow.wav",rpm:1e3,volume:.5},off_high:{source:"./audio/BAC_Mono_offveryhigh.wav",rpm:1e3,volume:.5},off_low:{source:"./audio/BAC_Mono_offlow.wav",rpm:1e3,volume:.5},limiter:{source:"./audio/limiter.wav",volume:.4,rpm:8e3}};t.sounds=s}const a=(await e.text()).split(`
`);let l="";for(let s of a){if(s=s.trim(),!s||s.startsWith(";")||s.startsWith("#"))continue;if(s.startsWith("[")&&s.endsWith("]")){l=s.slice(1,-1).toLowerCase();continue}const[d,u]=s.split("=").map(c=>c.trim());if(!d||!u)continue;let m=u;if(u==="true"?m=!0:u==="false"?m=!1:!isNaN(u)&&u!==""&&(m=parseFloat(u)),l==="engine"){const c=d.toLowerCase();if(c==="idle")t.engine.idle=m;else if(c==="limiter")t.engine.limiter=m;else if(c==="soft_limiter")t.engine.soft_limiter=m;else if(c==="limiter_ms")t.engine.limiter_ms=m;else if(c==="inertia")t.engine.inertia=m;else if(c==="torque")t.engine.torque=m;else if(c==="engine_braking")t.engine.engine_braking=m;else if(c==="video_path")t.engine.video_path=m,k=m,console.log("VIDEO_PATH set from INI:",m);else if(c==="type"&&!t.engine.video_path){const g=z(m);t.engine.video_path=g,k=g,console.log("VIDEO_PATH derived from TYPE:",m,"->",g)}}else if(l==="drivetrain"){const c=d.toLowerCase();if(c==="shift_time")t.drivetrain.shiftTime=m;else if(c==="damping")t.drivetrain.damping=m;else if(c==="compliance")t.drivetrain.compliance=m;else if(c==="final_drive")t.drivetrain.final_drive=m;else if(c==="gears"||c==="gear_ratios"){const g=u.split(",").map(p=>parseFloat(p.trim())).filter(p=>!isNaN(p));g.length>0&&(t.drivetrain.gears=g)}}else if(l==="gauges"){t.gauges||(t.gauges={});const c=d.toLowerCase();t.gauges[d]=m,t.gauges[c]=m}else if(l==="sounds"){const c=d.toLowerCase();let g=null,p=null;if(c.startsWith("on_high_")?(g="on_high",p=c.replace("on_high_","")):c.startsWith("on_low_")?(g="on_low",p=c.replace("on_low_","")):c.startsWith("off_high_")?(g="off_high",p=c.replace("off_high_","")):c.startsWith("off_low_")?(g="off_low",p=c.replace("off_low_","")):c.startsWith("limiter_")&&(g="limiter",p=c.replace("limiter_","")),g&&p)if(t.sounds[g]||(t.sounds[g]={}),p==="source"){let f=String(m||"");f.startsWith("/")?f="./"+f.slice(1):!f.startsWith("./")&&!f.startsWith("http://")&&!f.startsWith("https://")&&(f="./"+f),t.sounds[g].source=f}else p==="rpm"?t.sounds[g].rpm=m:p==="volume"&&(t.sounds[g].volume=m)}}return t}catch(e){return console.error(`Error loading INI config ${o}:`,e),i}}const j={};document.addEventListener("keydown",o=>{j[o.code]=!0});document.addEventListener("keyup",o=>{if(X){if(j[o.code]=!1,o.code.startsWith("Digit")){const i=+o.key;v.changeGear(i)}o.code=="ArrowUp"&&v.nextGear(),o.code=="ArrowDown"&&v.prevGear(),o.code=="KeyI"&&b&&(r.throttle>.1?(r.savedThrottle=r.throttle,r.throttle=.1):r.throttle=r.savedThrottle||.5,W&&(W.value=r.throttle.toString()))}});W?.addEventListener("input",o=>{if(!X)return;const i=parseFloat(o.target.value);r.throttle=R(i,0,1)});dt?.addEventListener("input",o=>{if(!X)return;const i=parseInt(o.target.value),e=["IDLE","LOW","MED","HIGH"];r.idle,r.idle*2,r.limiter*.5,r.limiter*.85,Ae&&(Ae.textContent=e[i]),i===0?r.throttle=.1:i===1?r.throttle=.3:i===2?r.throttle=.6:r.throttle=.9,W&&(W.value=r.throttle.toString())});de?.addEventListener("input",o=>{const i=parseInt(o.target.value);if(me&&(me.textContent=i.toString()),S&&i>=0){const e=parseInt(ce?.value||r.limiter.toString()||"9000");S.updateConfig({valueMin:i,valueStep:(e-i)/10})}});ce?.addEventListener("input",o=>{const i=parseInt(o.target.value);if(ue&&(ue.textContent=i.toString()),S){const e=parseInt(de?.value||"0");r.limiter=i,r.omega_max=2*Math.PI*i/60,S.updateConfig({valueMax:i,valueStep:(i-e)/10,valueRed:i*.85})}});const pe=[{value:"bac_mono",name:"2.5L Inline-4 (Ford Duratec)",engineName:"2.5L Inline-4 (Ford Duratec)",description:"Naturally aspirated inline-four producing 311 hp at 8,000 RPM. Lightweight track-focused engine.",category:"template",videoPath:"./assets/Engines/V/V8.mp4"},{value:"ferr_458",name:"4.5L V8 (Ferrari F136)",engineName:"4.5L V8 (Ferrari F136)",description:"Naturally aspirated V8 producing 570 hp at 9,000 RPM. High-revving Italian supercar engine.",category:"template",videoPath:"./assets/Engines/V/V8.mp4"},{value:"procar",name:"Racing V8",engineName:"Racing V8",description:"High-performance racing engine tuned for pro street and track competition. Aggressive power delivery.",category:"template",videoPath:"./assets/Engines/V/V8.mp4"},{value:"v2",name:"V2 Engine",engineName:"V-Twin",description:"Compact two-cylinder engine. Common in motorcycles and small performance vehicles.",category:"basic",videoPath:"./assets/Engines/V/V2.mp4"},{value:"v4",name:"V4 Engine",engineName:"V4",description:"Four-cylinder V-configuration. Balanced power and efficiency for compact applications.",category:"basic",videoPath:"./assets/Engines/V/V4.mp4"},{value:"v6",name:"V6 Engine",engineName:"V6",description:"Six-cylinder V-configuration. Popular in sports cars and performance sedans.",category:"basic",videoPath:"./assets/Engines/V/V6.mp4"},{value:"v8",name:"V8 Engine",engineName:"V8",description:"Eight-cylinder V-configuration. Classic American muscle and European supercar power.",category:"basic",videoPath:"./assets/Engines/V/V8.mp4"},{value:"v10",name:"V10 Engine",engineName:"V10",description:"Ten-cylinder V-configuration. Exotic supercar engine with exceptional power delivery.",category:"basic",videoPath:"./assets/Engines/V/V10.mp4"},{value:"v12",name:"V12 Engine",engineName:"V12",description:"Twelve-cylinder V-configuration. Ultimate luxury and performance in hypercars.",category:"basic",videoPath:"./assets/Engines/V/v12.mp4"},{value:"v16",name:"V16 Engine",engineName:"V16",description:"Sixteen-cylinder V-configuration. Extreme power for the ultimate performance machines.",category:"basic",videoPath:"./assets/Engines/V/V16.mp4"}];function Me(o){return new Promise(i=>{const e=document.createElement("video");e.src=o,e.crossOrigin="anonymous",e.muted=!0,e.currentTime=.1,e.onloadeddata=()=>{const t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight;const n=t.getContext("2d");n?(n.drawImage(e,0,0),i(t.toDataURL("image/jpeg",.8))):i("")},e.onerror=()=>i(""),e.load()})}function Ce(o,i){const e=document.createElement("div");e.style.cssText="background: #111; border: 2px solid #333; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden;",e.style.borderColor=o.category==="template"?"var(--accent-cyan)":"#555";const t=document.createElement("div");if(t.style.cssText="width: 100%; height: 120px; background: #000; border-radius: 4px; margin-bottom: 10px; overflow: hidden; position: relative;",i){const s=document.createElement("img");s.src=i,s.style.cssText="width: 100%; height: 100%; object-fit: cover;",t.appendChild(s)}else{const s=document.createElement("video");s.src=o.videoPath,s.muted=!0,s.currentTime=.1,s.style.cssText="width: 100%; height: 100%; object-fit: cover;",s.onloadeddata=()=>s.play().catch(()=>{}),t.appendChild(s)}const n=document.createElement("div");n.textContent=o.name,n.style.cssText=`color: ${o.category==="template"?"var(--accent-cyan)":"var(--text-light)"}; font-weight: bold; text-align: center; font-size: 16px; margin-bottom: 6px;`;const a=document.createElement("div");a.textContent=o.engineName||"",a.style.cssText="color: #888; font-size: 11px; text-align: center; margin-bottom: 8px; font-style: italic;";const l=document.createElement("div");return l.textContent=o.description||"",l.style.cssText="color: #aaa; font-size: 10px; text-align: center; line-height: 1.4; padding: 0 5px;",e.appendChild(t),e.appendChild(n),o.engineName&&e.appendChild(a),o.description&&e.appendChild(l),e.onmouseenter=()=>{e.style.borderColor="var(--accent-cyan)",e.style.boxShadow="0 0 15px rgba(102, 252, 241, 0.5)",e.style.transform="translateY(-2px)"},e.onmouseleave=()=>{e.style.borderColor=o.category==="template"?"var(--accent-cyan)":"#555",e.style.boxShadow="none",e.style.transform="translateY(0)"},e.onclick=()=>{Ve(o.value),L&&(L.style.display="none",document.body.classList.remove("modal-open"))},e}async function Ge(){if(!ae||!se||!_e)return;ae.innerHTML="",se.innerHTML="",_e.innerHTML="";const o=pe.filter(t=>t.category==="template"),i=pe.filter(t=>t.category==="basic");for(const t of o){const n=await Me(t.videoPath),a=Ce(t,n);ae.appendChild(a)}for(const t of i){const n=await Me(t.videoPath),a=Ce(t,n);se.appendChild(a)}const e=Re();if(e.length>0){Pe.style.display="block";for(const t of e){const n=await Me(t.videoPath||"./assets/Engines/V/V8.mp4"),a=Ce(t,n);_e.appendChild(a)}}else Pe.style.display="none"}async function Ve(o){if(!o)return;J.activeConfig=o;const i=JSON.parse(localStorage.getItem("torque_custom_configs")||"{}");if(i[o]){const l=i[o];window.currentEngineConfig=l,await E.init(l),await new Promise(m=>setTimeout(m,10)),console.log("Loading custom engine:",o),fe();const d=Re().find(m=>m.value===o);oe&&d&&(oe.textContent=d.name);const u=document.getElementById("engine-video");if(u){const m=l.engine?.video_path||z(l.engine?.type||"v8");k=m,u.src=m,u.load()}F(b?d.rpm:0);return}const e=pe.find(l=>l.value===o);oe&&e&&(oe.textContent=e.name);let n=await We(o);n||(n=Le[o]),window.currentEngineConfig=n,await E.init(n),await new Promise(l=>setTimeout(l,10)),console.log("Initializing gauges for engine:",o),console.log("Config gauges:",n.gauges),console.log("Engine limiter:",e.limiter),fe();const a=document.getElementById("engine-video");if(a){const l=k||z(o);k=l,console.log("Engine changed to:",o,"Video path:",l),a.pause(),a.currentTime=0,a.src=l,h&&(h.style.display="none"),a.onerror=s=>{console.error("Video load error on engine change:",l,a.error),h&&(h.style.display="none")},a.onloadeddata=()=>{console.log("Video loaded on engine change:",l),F(b?e.rpm:0),a.videoWidth>0&&Q()},a.oncanplay=()=>{console.log("Video can play on engine change:",l),F(b?e.rpm:0),a.videoWidth>0&&Q(),b&&e.rpm>0&&a.play().catch(s=>console.warn("Video play failed:",s))},a.load()}F(b?e.rpm:0)}rt?.addEventListener("click",()=>{L&&(L.style.display="block",document.body.classList.add("modal-open"),Ge(),B&&(B.value=""),M&&(M.style.display="none"))});lt?.addEventListener("click",()=>{L&&(L.style.display="none",document.body.classList.remove("modal-open")),B&&(B.value=""),M&&(M.style.display="none")});L?.addEventListener("click",o=>{o.target===L&&(L.style.display="none",document.body.classList.remove("modal-open"),B&&(B.value=""),M&&(M.style.display="none"))});document.addEventListener("keydown",o=>{o.key==="Escape"&&L&&L.style.display==="block"&&(L.style.display="none",document.body.classList.remove("modal-open"),B&&(B.value=""),M&&(M.style.display="none"))});let be=null;B?.addEventListener("input",o=>{const i=o.target.value.toLowerCase().trim();if(ct(i),!i){M&&(M.style.display="none");return}be&&clearTimeout(be),be=window.setTimeout(()=>{const e=pe.filter(t=>t.name.toLowerCase().includes(i)||t.value.toLowerCase().includes(i)).sort((t,n)=>{const a=t.name.toLowerCase().startsWith(i)||t.value.toLowerCase().startsWith(i),l=n.name.toLowerCase().startsWith(i)||n.value.toLowerCase().startsWith(i);return a&&!l?-1:!a&&l?1:t.name.localeCompare(n.name)});M&&(M.innerHTML="",e.length===0?M.innerHTML='<div style="padding: 12px; color: #888; font-size: 12px; text-align: center;">No engines found</div>':e.forEach(t=>{const n=document.createElement("div");n.style.cssText="padding: 12px; cursor: pointer; border-bottom: 1px solid #333; font-size: 13px; transition: background 0.2s; display: flex; align-items: center; gap: 10px;",n.style.color=t.category==="template"?"var(--accent-cyan)":"var(--text-light)";const a=document.createElement("span");a.textContent=t.name,a.style.fontWeight="bold";const l=document.createElement("span");l.textContent=t.category==="template"?"Template":"Basic",l.style.cssText=`font-size: 10px; padding: 2px 6px; border-radius: 3px; background: ${t.category==="template"?"rgba(102, 252, 241, 0.2)":"rgba(255, 255, 255, 0.1)"}; color: ${t.category==="template"?"var(--accent-cyan)":"#888"};`,n.appendChild(a),n.appendChild(l),n.onmouseenter=()=>{n.style.background="#222",n.style.color=t.category==="template"?"var(--accent-cyan)":"#fff"},n.onmouseleave=()=>{n.style.background="transparent",n.style.color=t.category==="template"?"var(--accent-cyan)":"var(--text-light)"},n.onclick=()=>{Ve(t.value),L&&(L.style.display="none",document.body.classList.remove("modal-open")),B&&(B.value=""),M&&(M.style.display="none")},M.appendChild(n)}),M.style.display="block")},150)});function ct(o){const i=ae?.children||[],e=se?.children||[],t=o.toLowerCase();Array.from(i).forEach(n=>{(n.querySelector("div:last-child")?.textContent?.toLowerCase()||"").includes(t)||t===""?n.style.display="block":n.style.display="none"}),Array.from(e).forEach(n=>{(n.querySelector("div:last-child")?.textContent?.toLowerCase()||"").includes(t)||t===""?n.style.display="block":n.style.display="none"})}document.addEventListener("click",o=>{M&&B&&!B.contains(o.target)&&!M.contains(o.target)&&(M.style.display="none")});Ne?.addEventListener("click",()=>{if(we){const o=we.style.display!=="none";we.style.display=o?"none":"block",Ne.textContent=o?"SHOW ADVANCED":"HIDE ADVANCED"}});Oe?.addEventListener("click",()=>{if(Ee){const o=Ee.style.display!=="none";Ee.style.display=o?"none":"block",Oe.textContent=o?"SHOW DRIVETRAIN":"HIDE DRIVETRAIN"}});const mt=()=>{const o=document.getElementById("slider-idle"),i=document.getElementById("slider-limiter"),e=document.getElementById("slider-soft-limiter"),t=document.getElementById("slider-inertia"),n=document.getElementById("slider-torque"),a=document.getElementById("slider-shift-time"),l=document.getElementById("slider-damping"),s=document.getElementById("slider-compliance");o?.addEventListener("input",c=>{r.idle=parseFloat(c.target.value),document.getElementById("val-idle").textContent=r.idle.toString()}),i?.addEventListener("input",c=>{r.limiter=parseFloat(c.target.value),r.omega_max=2*Math.PI*r.limiter/60,document.getElementById("val-limiter").textContent=r.limiter.toString(),S&&S.updateConfig({valueMax:r.limiter,valueStep:r.limiter/10,valueRed:r.limiter*.85})}),e?.addEventListener("input",c=>{r.soft_limiter=parseFloat(c.target.value),document.getElementById("val-soft-limiter").textContent=r.soft_limiter.toString()}),t?.addEventListener("input",c=>{r.inertia=parseFloat(c.target.value),document.getElementById("val-inertia").textContent=r.inertia.toFixed(1)}),n?.addEventListener("input",c=>{r.torque=parseFloat(c.target.value),document.getElementById("val-torque").textContent=r.torque.toString()}),a?.addEventListener("input",c=>{v.shiftTime=parseFloat(c.target.value),document.getElementById("val-shift-time").textContent=v.shiftTime.toString()}),l?.addEventListener("input",c=>{v.damping=parseFloat(c.target.value),document.getElementById("val-damping").textContent=v.damping.toString()}),s?.addEventListener("input",c=>{v.compliance=parseFloat(c.target.value),document.getElementById("val-compliance").textContent=v.compliance.toFixed(2)});const d=document.getElementById("export-config-btn"),u=document.getElementById("import-config-btn"),m=document.getElementById("import-config-file");d?.addEventListener("click",()=>{ft()}),u?.addEventListener("click",()=>{m?.click()}),m?.addEventListener("change",async c=>{const g=c.target.files?.[0];g&&(await pt(g),m.value="")}),slipAtRedlineCheckbox?.addEventListener("change",c=>{ie=c.target.checked,slipStartContainer&&(slipStartContainer.style.display=ie?"none":"block"),ie&&(D=r.limiter*.85,slipStartSlider&&(slipStartSlider.value=D.toString()),valSlipStart&&(valSlipStart.textContent=Math.round(D).toString()))}),slipStartSlider?.addEventListener("input",c=>{D=parseFloat(c.target.value),valSlipStart&&(valSlipStart.textContent=Math.round(D).toString())}),slipStartContainer&&slipAtRedlineCheckbox&&(slipStartContainer.style.display=slipAtRedlineCheckbox.checked?"none":"block")};function $e(){if(!E.audio.ctx){console.warn("Audio context not available for recording");return}if(x&&x.state!=="inactive")try{x.stop()}catch(i){console.warn("Error stopping old recorder:",i)}if(ee)try{E.audio.volume.disconnect(ee)}catch{}ee=E.audio.ctx.createMediaStreamDestination(),E.audio.volume.connect(ee);const o={mimeType:"audio/webm;codecs=opus",audioBitsPerSecond:128e3};MediaRecorder.isTypeSupported(o.mimeType)||(o.mimeType="audio/webm"),MediaRecorder.isTypeSupported(o.mimeType)||delete o.mimeType,x=new MediaRecorder(ee.stream,o),x.ondataavailable=i=>{i.data&&i.data.size>0&&te.push(i.data)},x.onerror=i=>{console.error("MediaRecorder error:",i),P.textContent="RECORDING ERROR // CHECK CONSOLE"},x.onstop=()=>{if(te.length===0){console.warn("No audio data recorded"),Se.classList.remove("rec-active"),ge.disabled=!1,he.disabled=!0,P.textContent="RECORDING FAILED // NO DATA";return}const i=new Blob(te,{type:x?.mimeType||"audio/webm"}),e=URL.createObjectURL(i),t=document.createElement("a");t.style.display="none",t.href=e,t.download=`engine_export_${Date.now()}.${i.type.includes("webm")?"webm":"wav"}`,document.body.appendChild(t),t.click(),window.URL.revokeObjectURL(e),document.body.removeChild(t),te=[],Se.classList.remove("rec-active"),ge.disabled=!1,he.disabled=!0,P.textContent="EXPORT COMPLETE // FILE DOWNLOADED"}}ge?.addEventListener("click",()=>{if(!X||!b){P.textContent="ENGINE MUST BE RUNNING // START ENGINE FIRST";return}if((!x||x.state==="inactive")&&$e(),!x){P.textContent="RECORDER INITIALIZATION FAILED // CHECK CONSOLE";return}try{te=[],x.start(100),Se.classList.add("rec-active"),ge.disabled=!0,he.disabled=!1,P.textContent="RECORDING // CAPTURING AUDIO"}catch(o){console.error("Failed to start recording:",o),P.textContent="RECORDING FAILED // CHECK CONSOLE"}});he?.addEventListener("click",()=>{if(x)try{x.state==="recording"?x.stop():x.state==="inactive"&&(P.textContent="NOT RECORDING // PRESS REC FIRST")}catch(o){console.error("Failed to stop recording:",o),P.textContent="STOP FAILED // CHECK CONSOLE"}});fe();let Z=!1;function ut(){if(!(!X||Z)){if(Z=!0,r.throttle=0,r.rpm=0,r.omega=0,r.theta=0,r.alpha=0,v.gear=0,v.omega=0,v.theta=0,E.audio&&E.audio.samples)for(const o in E.audio.samples)E.audio.samples[o].gain&&(E.audio.samples[o].gain.gain.value=0);E.audio&&E.audio.volume&&(E.audio.volume.gain.value=0),b=!1,Z=!1,Te.style.display="block",Be.style.display="none",P.textContent="ENGINE STOPPED // SYSTEM READY",F(0),A&&A.setValue(0),S&&S.setValue(0),W&&(W.value="0"),le&&(le.textContent="0.00"),requestAnimationFrame(()=>{A&&A.setValue(0),S&&S.setValue(0)})}}Te?.addEventListener("click",gt);Be?.addEventListener("click",ut);async function gt(){let i=await We(J.activeConfig);i||(i=Le[J.activeConfig]),window.currentEngineConfig=i,await E.init(i),await new Promise($=>setTimeout($,10)),fe(),X=!0,b=!0,Te.style.display="none",Be.style.display="block",P.textContent="ENGINE RUNNING // READY";const e=document.getElementById("engine-video");if(e){const $=k||z(J.activeConfig),qe=e.src&&e.src.split("/").pop()?.split("?")[0]||"",Ue=$.split("/").pop()||"";(!e.src||qe!==Ue)&&(e.src=$,k=$,e.load(),e.addEventListener("canplay",()=>{b&&r.rpm>0&&e.play().catch(ze=>console.warn("Video play failed:",ze))},{once:!0})),e.style.display="block",e.style.visibility="visible";const ye=document.getElementById("gif-container");ye&&(ye.style.display="flex",ye.style.visibility="visible")}F(r.rpm),mt(),$e();const t=document.getElementById("val-idle"),n=document.getElementById("val-limiter"),a=document.getElementById("val-soft-limiter"),l=document.getElementById("val-inertia"),s=document.getElementById("val-torque"),d=document.getElementById("val-shift-time"),u=document.getElementById("val-damping"),m=document.getElementById("val-compliance");if(t&&(t.textContent=r.idle.toString()),n&&(n.textContent=r.limiter.toString()),a&&(a.textContent=r.soft_limiter.toString()),l&&(l.textContent=r.inertia.toFixed(1)),s&&(s.textContent=r.torque.toString()),d&&(d.textContent=v.shiftTime.toString()),u&&(u.textContent=v.damping.toString()),m&&(m.textContent=v.compliance.toFixed(2)),de&&(de.value="0",me&&(me.textContent="0")),ce){const $=r.limiter||9e3;ce.value=$.toString(),ue&&(ue.textContent=$.toString())}const c=document.getElementById("slider-idle"),g=document.getElementById("slider-limiter"),p=document.getElementById("slider-soft-limiter"),f=document.getElementById("slider-inertia"),C=document.getElementById("slider-torque"),_=document.getElementById("slider-shift-time"),I=document.getElementById("slider-damping"),T=document.getElementById("slider-compliance");c&&(c.value=r.idle.toString()),g&&(g.value=r.limiter.toString()),p&&(p.value=r.soft_limiter.toString()),f&&(f.value=r.inertia.toString()),C&&(C.value=r.torque.toString()),_&&(_.value=v.shiftTime.toString()),I&&(I.value=v.damping.toString()),T&&(T.value=v.compliance.toString()),D=r.limiter*.85;const H=document.getElementById("slip-at-redline"),ve=document.getElementById("slider-slip-start"),ke=document.getElementById("val-slip-start");ve&&(ve.value=Math.round(D).toString(),ve.max=r.limiter.toString()),ke&&(ke.textContent=Math.round(D).toString()),H&&(ie=H.checked)}let y=null,N=0,O=0,V=1,q=!1,Y=0,K=0,Ie=null;w&&(y=w.getContext("2d"),y&&(y.fillStyle="#66fcf1",y.strokeStyle="#66fcf1",y.lineWidth=2),w.addEventListener("mousedown",o=>{q=!0,Y=o.clientX,K=o.clientY,w.style.cursor="grabbing"}),w.addEventListener("mousemove",o=>{if(q){const i=o.clientX-Y,e=o.clientY-K,t=w.width*(V-1),n=w.height*(V-1);N=Math.max(-t,Math.min(t,N+i)),O=Math.max(-n,Math.min(n,O+e)),Y=o.clientX,K=o.clientY}}),w.addEventListener("mouseup",()=>{q=!1,w.style.cursor="grab"}),w.addEventListener("mouseleave",()=>{q=!1,w.style.cursor="grab"}),w.addEventListener("wheel",o=>{o.preventDefault();const i=o.deltaY>0?.9:1.1,e=Math.max(1,Math.min(5,V*i)),t=e/V,n=w.getBoundingClientRect(),a=o.clientX-n.left,l=o.clientY-n.top;N=a-(a-N)*t,O=l-(l-O)*t,V=e;const s=w.width*(V-1),d=w.height*(V-1);N=Math.max(-s,Math.min(s,N)),O=Math.max(-d,Math.min(d,O))}),w.addEventListener("touchstart",o=>{o.touches.length===1&&(q=!0,Y=o.touches[0].clientX,K=o.touches[0].clientY)}),w.addEventListener("touchmove",o=>{if(q&&o.touches.length===1){o.preventDefault();const i=o.touches[0].clientX-Y,e=o.touches[0].clientY-K,t=w.width*(V-1),n=w.height*(V-1);N=Math.max(-t,Math.min(t,N+i)),O=Math.max(-n,Math.min(n,O+e)),Y=o.touches[0].clientX,K=o.touches[0].clientY}}),w.addEventListener("touchend",()=>{q=!1}));function ht(){if(v.gear===0)return 0;const o=.25,i=v.getTotalGearRatio();return r.rpm/i/60*2*Math.PI*o*3.6}function z(o){return{v2:"./assets/Engines/V/V2.mp4",v4:"./assets/Engines/V/V4.mp4",v6:"./assets/Engines/V/V6.mp4",v8:"./assets/Engines/V/V8.mp4",v10:"./assets/Engines/V/V10.mp4",v12:"./assets/Engines/V/v12.mp4",v16:"./assets/Engines/V/V16.mp4"}[o.toLowerCase()]||"./assets/Engines/V/V8.mp4"}function Q(){const o=document.getElementById("engine-video");if(!o||!h)return;if(o.videoWidth===0||o.videoHeight===0){h.style.display="none";return}h.style.display="block";const i=h.getContext("2d",{alpha:!0});if(!i)return;i.clearRect(0,0,h.width,h.height),i.drawImage(o,0,0,h.width,h.height);const e=i.getImageData(0,0,h.width,h.height),t=e.data,n=30;for(let a=0;a<t.length;a+=4){const l=t[a],s=t[a+1],d=t[a+2];l<n&&s<n&&d<n&&(t[a+3]=0)}i.putImageData(e,0,0)}function F(o){const i=document.getElementById("gif-container"),e=document.getElementById("engine-video"),t=document.getElementById("engine-status");if(!i||!e){console.error("Video elements not found:",{gifContainer:!!i,engineVideo:!!e});return}const n=Math.max(0,Math.min(1,(o-r.idle)/(r.limiter-r.idle))),a=o>=r.limiter*.85,l=o>=r.limiter*.9;if(b&&o>=1){const d=k||"./assets/Engines/V/V8.mp4";e.src&&e.src.split("?")[0].split("/").pop(),d.split("/").pop();const u=_=>_.toLowerCase().split("/").pop()||"",m=e.src?u(e.src):"",c=u(d);if((!e.src||m!==c)&&(console.log("Loading video:",d,"Current:",m,"Target:",c),h&&(h.style.display="none"),e.src=d,k=d,e.onerror=_=>{console.error("Video load error:",d,e.error),h&&(h.style.display="none")},e.onloadeddata=()=>{console.log("Video loaded:",d),h&&e.videoWidth>0&&(h.style.display="block"),e.play().catch(_=>console.warn("Video play failed:",_))},e.oncanplay=()=>{console.log("Video can play:",d),h&&e.videoWidth>0&&(h.style.display="block"),b&&r.rpm>0&&e.play().catch(_=>console.warn("Video play failed:",_))},e.load()),e.paused&&e.readyState>=2&&e.videoWidth>0)e.play().catch(_=>console.warn("Video play failed:",_)),h&&e.videoWidth>0&&(h.style.display="block");else if(e.paused&&(e.readyState<2||e.videoWidth===0)){const _=()=>{e.readyState>=2&&e.videoWidth>0&&e.paused?(e.play().catch(I=>console.warn("Video play failed:",I)),h&&(h.style.display="block")):(e.readyState<2||e.videoWidth===0)&&setTimeout(_,100)};e.addEventListener("canplay",()=>{e.videoWidth>0&&(e.play().catch(I=>console.warn("Video play failed:",I)),h&&(h.style.display="block"))},{once:!0}),_()}e.style.display="block",e.style.visibility="visible",e.style.opacity="1",i.style.opacity="1",i.style.display="flex",i.style.visibility="visible";const g=.25+n*2.75;e.playbackRate=R(g,.25,3),i.style.opacity="1",i.style.display="flex",i.style.visibility="visible";let p="",f="";if(l){p=`brightness(1.3) contrast(1.4) sepia(${.9}) saturate(3.5) hue-rotate(-20deg)`;const I=(Math.random()-.5)*6,T=(Math.random()-.5)*6,H=Math.sin(Date.now()/45)*4;f=`translate(${I}px, ${T}px) rotate(${H}deg)`}else if(a){p="brightness(1.2) contrast(1.3) sepia(0.6) saturate(2.5) hue-rotate(-15deg)";const _=(Math.random()-.5)*4,I=(Math.random()-.5)*4,T=Math.sin(Date.now()/50)*3;f=`translate(${_}px, ${I}px) rotate(${T}deg)`}else if(o>r.idle+500){p="brightness(1.1) contrast(1.2) sepia(0.3) saturate(1.5) hue-rotate(60deg)";const _=n*2,I=250-n*150;f=`rotate(${Math.sin(Date.now()/I)*_}deg)`}else p="brightness(1.05) contrast(1.1) sepia(0.2) saturate(1.3) hue-rotate(40deg)",f="none";e.style.filter=p,e.style.transform=f,e.style.display="block",e.style.visibility="hidden",e.style.background="transparent";const C=document.getElementById("engine-logo");C&&(C.style.display="block",C.style.opacity="0.3",C.style.filter="blur(8px) brightness(0.5)",C.style.zIndex="1",C.style.top="0",C.style.left="0",C.style.width="100%",C.style.height="100%",C.style.objectFit="fill"),h&&(h.style.filter=p,h.style.transform=f,h.style.zIndex="2"),Q(),t&&(t.textContent="Engine Running")}else{e.pause(),e.currentTime=0;const d=document.getElementById("engine-logo");if(d&&(d.style.display="block",d.style.opacity="0.6",d.style.filter="brightness(0.8) contrast(0.9)",d.style.zIndex="1",d.style.top="0",d.style.left="0",d.style.width="100%",d.style.height="100%",d.style.objectFit="fill"),i.style.opacity="0.6",i.style.display="flex",i.style.visibility="visible",e.style.filter="brightness(0.2) contrast(0.5) saturate(0.3)",e.style.transform="none",e.style.display="block",e.style.visibility="hidden",h&&(h.style.filter="brightness(0.2) contrast(0.5) saturate(0.3)",h.style.transform="none",h.style.zIndex="2",e.videoWidth>0&&e.videoHeight>0&&(h.style.display="block")),Q(),e.src)e.readyState>=2&&e.videoWidth>0&&(e.currentTime=0,h&&(h.style.display="block"),Q());else{const u=k||"./assets/Engines/V/V8.mp4";console.log("Setting video source when off:",u),e.src=u,e.load()}t&&(t.textContent="Engine Off")}}let Fe=new Date().getTime(),xe=0,U=0;function He(o){if(requestAnimationFrame(n=>{He(n)}),xe=new Date().getTime(),U=(xe-Fe)/1e3,Fe=xe,U===0||!X)return;if(Z&&(b||(Z=!1)),!b&&!Z){A&&A.setValue(0),S&&S.setValue(0),F(0);return}if(A){const n=ht();A.setValue(n)}if(S){const n=r.limiter*.85,a=Math.min(r.rpm,n);S.setValue(a)}const i=document.getElementById("gear-value"),e=document.getElementById("gear-arrow");if(i){const n=v.gear;n===0?(i.textContent="N",e&&(e.textContent="→")):n>0?(i.textContent=n.toString(),e&&(e.textContent="→")):(i.textContent="R",e&&(e.textContent="←"))}const t=ie?r.limiter*.85:D;if(b&&r.rpm>=t){const n=Math.min(1,(r.rpm-t)/(r.limiter-t)),a=Math.sin(Date.now()/100)*n*.15;r.throttle=R(r.throttle+a,0,1);const l=Math.sin(Date.now()/80)*n*50;r.rpm=R(r.rpm+l*U,r.idle,r.limiter)}if(F(r.rpm),Q(),le&&(le.textContent=r.throttle.toFixed(2)),W&&(W.value=r.throttle.toString()),v.downShift?r.throttle=.8:j.KeyW?r.throttle=R(r.throttle+=.2,0,1):j.KeyS?r.throttle=R(r.throttle-=.2,0,1):r.throttle=R(r.throttle-=.1,0,1),b){if(j.KeyS&&(v.omega-=.3),E.update(o,U),j.Space){if(r.rpm>r.idle){const n=3*U;r.omega=Math.max(r.omega-n,2*Math.PI*r.idle/60),r.rpm=60*r.omega/(2*Math.PI)}if(v.omega>0){const n=3*U;v.omega=Math.max(v.omega-n,0)}r.throttle>0&&(r.throttle=Math.max(r.throttle-.5*U,0))}}else if(E.audio&&E.audio.samples)for(const n in E.audio.samples)E.audio.samples[n].gain&&(E.audio.samples[n].gain.gain.value=0);if(y&&E.audio.analyser&&b){const n=w.width=w.offsetWidth,a=w.height=w.offsetHeight,l=E.audio.analyser.frequencyBinCount;Ie=new Uint8Array(l),E.audio.analyser.getByteTimeDomainData(Ie),y.clearRect(0,0,n,a),y.strokeStyle="rgba(102, 252, 241, 0.3)",y.lineWidth=1,y.beginPath(),y.moveTo(0,a/2),y.lineTo(n,a/2),y.stroke(),y.save(),y.translate(-N,-O),y.scale(V,V),y.beginPath(),y.lineJoin="round",y.lineWidth=Math.max(1,2/V),y.strokeStyle="#66fcf1";const s=n/l,d=a/2;let u=0;y.moveTo(0,d);for(let m=0;m<l;m++){const c=Ie[m]/128,g=d+(c-1)*d;y.lineTo(u,g),u+=s}y.stroke(),y.restore()}else if(y&&w){const n=w.width=w.offsetWidth,a=w.height=w.offsetHeight;y.clearRect(0,0,n,a),y.strokeStyle="rgba(102, 252, 241, 0.2)",y.lineWidth=1,y.beginPath(),y.moveTo(0,a/2),y.lineTo(n,a/2),y.stroke()}}function ft(){const o=J.activeConfig||"custom",i=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5),e=`${o}_${i}.ini`;let t=`[Engine]
`;if(t+=`TYPE=${o}
`,t+=`VIDEO_PATH=${k||z(o)}
`,t+=`IDLE=${r.idle}
`,t+=`LIMITER=${r.limiter}
`,t+=`SOFT_LIMITER=${r.soft_limiter}
`,t+=`LIMITER_MS=${r.limiter_ms||0}
`,t+=`INERTIA=${r.inertia}
`,t+=`TORQUE=${r.torque}
`,t+=`ENGINE_BRAKING=${r.engine_braking||200}
`,t+=`
[Drivetrain]
`,t+=`SHIFT_TIME=${v.shiftTime}
`,t+=`DAMPING=${v.damping}
`,t+=`COMPLIANCE=${v.compliance||.01}
`,t+=`FINAL_DRIVE=${v.final_drive||3.44}
`,v.gears&&v.gears.length>0&&(t+=`GEARS=${v.gears.join(",")}
`),window.currentEngineConfig?.gauges){const s=window.currentEngineConfig.gauges;t+=`
[Gauges]
`,(s.max_speed_kmh||s.MAX_SPEED_KMH)&&(t+=`MAX_SPEED_KMH=${s.max_speed_kmh||s.MAX_SPEED_KMH}
`),(s.max_speed_mph||s.MAX_SPEED_MPH)&&(t+=`MAX_SPEED_MPH=${s.max_speed_mph||s.MAX_SPEED_MPH}
`),(s.rpm_start||s.RPM_START)&&(t+=`RPM_START=${s.rpm_start||s.RPM_START}
`),(s.rpm_end||s.RPM_END)&&(t+=`RPM_END=${s.rpm_end||s.RPM_END}
`)}if(window.currentEngineConfig?.sounds){const s=window.currentEngineConfig.sounds;t+=`
[Sounds]
`,s.on_high&&(s.on_high.source&&(t+=`ON_HIGH_SOURCE=${s.on_high.source}
`),s.on_high.rpm!==void 0&&(t+=`ON_HIGH_RPM=${s.on_high.rpm}
`),s.on_high.volume!==void 0&&(t+=`ON_HIGH_VOLUME=${s.on_high.volume}
`)),s.on_low&&(s.on_low.source&&(t+=`ON_LOW_SOURCE=${s.on_low.source}
`),s.on_low.rpm!==void 0&&(t+=`ON_LOW_RPM=${s.on_low.rpm}
`),s.on_low.volume!==void 0&&(t+=`ON_LOW_VOLUME=${s.on_low.volume}
`)),s.off_high&&(s.off_high.source&&(t+=`OFF_HIGH_SOURCE=${s.off_high.source}
`),s.off_high.rpm!==void 0&&(t+=`OFF_HIGH_RPM=${s.off_high.rpm}
`),s.off_high.volume!==void 0&&(t+=`OFF_HIGH_VOLUME=${s.off_high.volume}
`)),s.off_low&&(s.off_low.source&&(t+=`OFF_LOW_SOURCE=${s.off_low.source}
`),s.off_low.rpm!==void 0&&(t+=`OFF_LOW_RPM=${s.off_low.rpm}
`),s.off_low.volume!==void 0&&(t+=`OFF_LOW_VOLUME=${s.off_low.volume}
`)),s.limiter&&(s.limiter.source&&(t+=`LIMITER_SOURCE=${s.limiter.source}
`),s.limiter.rpm!==void 0&&(t+=`LIMITER_RPM=${s.limiter.rpm}
`),s.limiter.volume!==void 0&&(t+=`LIMITER_VOLUME=${s.limiter.volume}
`))}const n=new Blob([t],{type:"text/plain"}),a=URL.createObjectURL(n),l=document.createElement("a");l.href=a,l.download=e,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(a),console.log("Exported configuration to:",e)}async function pt(o){try{const i=await o.text(),e=o.name.replace(".ini","").replace(/[^a-zA-Z0-9_]/g,"_"),t=await vt(i,e),n=Re(),a=n.findIndex(d=>d.value===e),l={value:e,name:t.engine?.name||e.replace(/_/g," ").replace(/\b\w/g,d=>d.toUpperCase()),engineName:t.engine?.name||e,description:`Custom imported configuration: ${o.name}`,category:"custom",videoPath:t.engine?.video_path||z(t.engine?.type||"v8")};a>=0?n[a]=l:n.push(l);const s=JSON.parse(localStorage.getItem("torque_custom_configs")||"{}");s[e]=t,localStorage.setItem("torque_custom_configs",JSON.stringify(s)),localStorage.setItem("torque_custom_engines",JSON.stringify(n)),await Ge(),await Ve(e),console.log("Imported configuration:",e),alert(`Configuration imported successfully! "${l.name}" is now available in the engine selection modal.`)}catch(i){console.error("Error importing INI file:",i),alert("Error importing INI file. Please check the file format.")}}function vt(o,i){return new Promise(e=>{const t={engine:{},drivetrain:{},sounds:{},gauges:{}},n=o.split(`
`);let a="";for(let l of n){if(l=l.trim(),!l||l.startsWith(";")||l.startsWith("#"))continue;if(l.startsWith("[")&&l.endsWith("]")){a=l.slice(1,-1).toLowerCase();continue}const[s,d]=l.split("=").map(m=>m.trim());if(!s||!d)continue;let u=d;if(d==="true"?u=!0:d==="false"?u=!1:!isNaN(d)&&d!==""&&(u=parseFloat(d)),a==="engine"){const m=s.toLowerCase();m==="idle"?t.engine.idle=u:m==="limiter"?t.engine.limiter=u:m==="soft_limiter"?t.engine.soft_limiter=u:m==="limiter_ms"?t.engine.limiter_ms=u:m==="inertia"?t.engine.inertia=u:m==="torque"?t.engine.torque=u:m==="engine_braking"?t.engine.engine_braking=u:m==="type"?t.engine.type=u:m==="video_path"&&(t.engine.video_path=u)}else if(a==="drivetrain"){const m=s.toLowerCase();if(m==="shift_time")t.drivetrain.shiftTime=u;else if(m==="damping")t.drivetrain.damping=u;else if(m==="compliance")t.drivetrain.compliance=u;else if(m==="final_drive")t.drivetrain.final_drive=u;else if(m==="gears"||m==="gear_ratios"){const c=d.split(",").map(g=>parseFloat(g.trim())).filter(g=>!isNaN(g));c.length>0&&(t.drivetrain.gears=c)}}else if(a==="gauges"){t.gauges||(t.gauges={});const m=s.toLowerCase();t.gauges[s]=u,t.gauges[m]=u}else if(a==="sounds"){const m=s.toLowerCase();let c=null,g=null;if(m.startsWith("on_high_")?(c="on_high",g=m.replace("on_high_","")):m.startsWith("on_low_")?(c="on_low",g=m.replace("on_low_","")):m.startsWith("off_high_")?(c="off_high",g=m.replace("off_high_","")):m.startsWith("off_low_")?(c="off_low",g=m.replace("off_low_","")):m.startsWith("limiter_")&&(c="limiter",g=m.replace("limiter_","")),c&&g)if(t.sounds[c]||(t.sounds[c]={}),g==="source"){let p=String(u||"");p.startsWith("/")?p="./"+p.slice(1):!p.startsWith("./")&&!p.startsWith("http://")&&!p.startsWith("https://")&&(p="./"+p),t.sounds[c].source=p}else g==="rpm"?t.sounds[c].rpm=u:g==="volume"&&(t.sounds[c].volume=u)}}e(t)})}function Re(){try{return JSON.parse(localStorage.getItem("torque_custom_engines")||"[]")}catch(o){return console.error("Error loading custom engines:",o),[]}}He(10);
